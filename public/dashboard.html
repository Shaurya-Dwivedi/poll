<!DOCTYPE html>
<html>
<head>
  <title>Instructor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">üìä Polling Dashboard</h1>
      <div>
        <span id="welcomeUser" class="me-3"></span>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Student Search Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">üîç Student Search</h5>
        <div class="row">
          <div class="col-md-8">
            <input type="text" id="studentSearch" class="form-control" placeholder="Search by Roll No, Name, or Email..." onkeyup="searchStudents()">
          </div>
          <div class="col-md-4">
            <button class="btn btn-secondary w-100" onclick="loadAllStudents()">üìã View All Students</button>
          </div>
        </div>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Create Poll</h5>
            <div class="mb-3">
              <label for="question" class="form-label">Question:</label>
              <input type="text" id="question" class="form-control">
            </div>
            <label class="form-label">Options:</label>
            <div class="input-group mb-2">
              <span class="input-group-text">A</span>
              <input type="text" id="optA" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">B</span>
              <input type="text" id="optB" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">C</span>
              <input type="text" id="optC" class="form-control">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">D</span>
              <input type="text" id="optD" class="form-control">
            </div>
            <div class="row">
              <div class="col">
                <label for="correct" class="form-label">Correct Option:</label>
                <select id="correct" class="form-select">
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                </select>
              </div>
              <div class="col">
                <label for="duration" class="form-label">Duration (s):</label>
                <input type="number" id="duration" value="30" min="10" class="form-control">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-danger" onclick="logoutAll()">Logout All Devices</button>
                <div>
                  <button class="btn btn-warning me-2" id="endPollBtn" onclick="endPoll()" style="display: none;">‚èπÔ∏è End Poll</button>
                  <button class="btn btn-primary" id="startPollBtn" onclick="startPoll()">üöÄ Start Poll</button>
                </div>
            </div>
            <div id="pollStatus" class="mt-3"></div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Live Results</h5>
            <div id="timer" class="fs-4 text-center my-3"></div>
            <div id="results">Waiting for votes...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Student Responses</h5>
            <div id="studentTable"></div>
            <button class="btn btn-secondary mt-3" onclick="downloadCSV()">üì• Export as CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check if user is logged in
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
      alert('Please login first');
      window.location.href = '/';
    } else {
      const welcomeEl = document.getElementById('welcomeUser');
      if (welcomeEl) {
        welcomeEl.textContent = `Welcome, ${loggedInUser.name || loggedInUser.username}!`;
      }
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('loggedInUser');
        window.location.href = '/';
      }
    }

    // Use relative URLs when hosted on same domain, or set full URL for separate hosting
    const server = window.location.origin;
    let currentPollId = null; // Track the current active poll

    function logoutAll() {
      fetch(server + "/logout_all", { method: "POST" })
        .then(res => res.json())
        .then(() => alert("‚úÖ All devices will be logged out"));
    }

    function startPoll() {
      const question = document.getElementById("question").value;
      const options = {
        A: document.getElementById("optA").value,
        B: document.getElementById("optB").value,
        C: document.getElementById("optC").value,
        D: document.getElementById("optD").value
      };
      const correct = document.getElementById("correct").value;
      const duration = document.getElementById("duration").value;

      if (!question || !options.A || !options.B || !options.C || !options.D) {
        document.getElementById("pollStatus").innerHTML = "<div class='alert alert-warning'>‚ö†Ô∏è Please fill all fields</div>";
        return;
      }

      fetch(`${server}/start_poll`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, options, correct, duration })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          currentPollId = data.pollId; // Store the poll ID
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-success'>‚úÖ Poll started!</div>";
          document.getElementById("startPollBtn").disabled = true;
          document.getElementById("endPollBtn").style.display = "inline-block";
        } else {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-danger'>‚ùå " + (data.message || "Failed to start poll") + "</div>";
        }
      });
    }

    function endPoll() {
      if (!confirm("Are you sure you want to end this poll now? Students won't be able to vote anymore.")) {
        return;
      }

      fetch(`${server}/end_poll`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          currentPollId = null; // Clear the poll ID
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-info'>üî¥ Poll ended manually</div>";
          document.getElementById("startPollBtn").disabled = false;
          document.getElementById("endPollBtn").style.display = "none";
        } else {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-danger'>‚ùå " + (data.message || "Failed to end poll") + "</div>";
        }
      });
    }

    // Student Search Functions
    let searchTimeout;
    function searchStudents() {
      clearTimeout(searchTimeout);
      const query = document.getElementById("studentSearch").value.trim();
      
      if (query.length < 2) {
        document.getElementById("searchResults").innerHTML = "";
        return;
      }

      searchTimeout = setTimeout(() => {
        fetch(`${server}/search_students?query=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            displaySearchResults(data);
          })
          .catch(error => {
            console.error("Search error:", error);
            document.getElementById("searchResults").innerHTML = "<div class='alert alert-danger'>Error searching students</div>";
          });
      }, 300); // Debounce 300ms
    }

    function loadAllStudents() {
      document.getElementById("searchResults").innerHTML = "<div class='text-center'><div class='spinner-border' role='status'></div><p>Loading all students...</p></div>";
      
      fetch(`${server}/all_students?limit=100`)
        .then(res => res.json())
        .then(data => {
          displaySearchResults(data);
        })
        .catch(error => {
          console.error("Load error:", error);
          document.getElementById("searchResults").innerHTML = "<div class='alert alert-danger'>Error loading students</div>";
        });
    }

    function displaySearchResults(data) {
      const resultsDiv = document.getElementById("searchResults");
      
      if (!data.success || data.students.length === 0) {
        resultsDiv.innerHTML = "<div class='alert alert-warning'>No students found</div>";
        return;
      }

      let html = `<div class="alert alert-info">Found ${data.count || data.students.length} student(s)`;
      if (data.total) {
        html += ` (Page ${data.page}/${data.pages}, Total: ${data.total})`;
      }
      html += `</div>`;
      
      html += `<div class="table-responsive"><table class="table table-striped table-hover table-sm">
        <thead>
          <tr>
            <th>SN</th>
            <th>Roll No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Section</th>
            <th>Group</th>
            <th>Branch</th>
            <th>Device Code</th>
          </tr>
        </thead>
        <tbody>`;
      
      data.students.forEach(student => {
        html += `<tr>
          <td>${student.sn}</td>
          <td><strong>${student.rollNo}</strong></td>
          <td>${student.name}</td>
          <td><small>${student.email}</small></td>
          <td>${student.section}</td>
          <td>${student.subGroup}</td>
          <td><span class="badge bg-primary">${student.branch}</span></td>
          <td><code>${student.deviceCode || 'N/A'}</code></td>
        </tr>`;
      });
      
      html += `</tbody></table></div>`;
      
      resultsDiv.innerHTML = html;
    }

    function fetchResults() {
      // Fetch results - the endpoint now only returns active poll results
      fetch(`${server}/results`)
        .then(res => res.json())
        .then(data => {
          if (!data.active) {
            // No active poll - clear the results display
            currentPollId = null;
            document.getElementById("results").innerHTML = "<div class='alert alert-info'>No active poll. Start a new poll to see results.</div>";
            document.getElementById("studentTable").innerHTML = "";
            return;
          }
          
          // Update the current poll ID
          currentPollId = data.pollId;
          
          const summary = data.summary;
          const details = data.details;

          let summaryHTML = "<ul class='list-group'>";
          for (let option in summary) {
            summaryHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>${option}: <strong>${summary[option]} votes</strong></li>`;
          }
          summaryHTML += "</ul>"
          document.getElementById("results").innerHTML = summaryHTML || "No votes yet.";

          // Student response table
          let table = `<table class="table table-striped table-hover">
            <thead><tr><th>Roll No</th><th>Name</th><th>Vote</th><th>Correct?</th></tr></thead><tbody>`;
          for (let s of details) {
            const icon = s.correct ? "‚úÖ" : "‚ùå";
            table += `<tr><td>${s.rollNo}</td><td>${s.name}</td><td>${s.vote}</td><td>${icon}</td></tr>`;
          }
          table += "</tbody></table>";
          document.getElementById("studentTable").innerHTML = table;
        })
        .catch(error => {
          console.error("Error fetching results:", error);
        });
    }

    function downloadCSV() {
      window.open(`${server}/export`, "_blank");
    }

    setInterval(fetchResults, 3000); // update every 3 sec
    setInterval(() => {
      fetch(`${server}/poll`)
        .then(res => res.json())
        .then(data => {
          if (data.active) {
            document.title = `‚è≥ ${data.timeLeft}s left - ${data.question}`;
            document.getElementById("timer").innerHTML = `Time Left: <span class="badge bg-success">${data.timeLeft}s</span>`;
            document.getElementById("endPollBtn").style.display = "inline-block";
            document.getElementById("startPollBtn").disabled = true;
          } else {
            document.title = "‚úÖ Poll Ended";
            document.getElementById("timer").innerHTML = '';
            document.getElementById("endPollBtn").style.display = "none";
            document.getElementById("startPollBtn").disabled = false;
          }
        });
    }, 1000);
  </script>
</body>
</html>
