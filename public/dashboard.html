<!DOCTYPE html>
<html>
<head>
  <title>Instructor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .dashboard-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 300px;
      background-color: #ffffff;
      border-right: 2px solid #dee2e6;
      overflow-y: auto;
      transition: width 0.3s;
      flex-shrink: 0;
    }
    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 15px;
      background-color: #0d6efd;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-content {
      padding: 10px;
    }
    .history-item {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .history-item:hover {
      background-color: #e9ecef;
    }
    .history-item.active {
      background-color: #cfe2ff;
      border-color: #0d6efd;
    }
    .history-question {
      font-weight: 500;
      font-size: 14px;
      color: #212529;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .history-meta {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
    .history-details {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }
    .history-details.expanded {
      display: block;
    }
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .toggle-sidebar-btn {
      position: fixed;
      top: 20px;
      left: 10px;
      z-index: 1000;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sidebar.collapsed + .main-content .toggle-sidebar-btn {
      left: 10px;
    }
    .card {
      margin-bottom: 20px;
    }
    .history-search {
      margin-bottom: 10px;
    }
    .poll-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 3px;
      margin-left: 5px;
    }
    .poll-badge.active {
      background-color: #198754;
      color: white;
    }
    .poll-badge.completed {
      background-color: #6c757d;
      color: white;
    }
    .history-actions {
      margin-top: 8px;
      display: flex;
      gap: 5px;
    }
    .history-actions button {
      padding: 3px 8px;
      font-size: 11px;
    }
    .sidebar-tabs {
      display: flex;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    .sidebar-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      background-color: transparent;
      border: none;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.2s;
    }
    .sidebar-tab:hover {
      background-color: #e9ecef;
    }
    .sidebar-tab.active {
      background-color: #0d6efd;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar for History -->
    <div class="sidebar" id="historySidebar">
      <div class="sidebar-header">
        <div>
          <h6 class="mb-0">History</h6>
          <small id="historyCount">Loading...</small>
        </div>
        <button class="btn btn-sm btn-light" onclick="toggleSidebar()" title="Collapse">
          &times;
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="switchTab('polls')">Polls</button>
        <button class="sidebar-tab" onclick="switchTab('attendance')">Attendance</button>
      </div>
      
      <!-- Poll History Tab -->
      <div class="sidebar-content tab-content active" id="pollsTab">
        <input type="text" class="form-control form-control-sm history-search" 
               id="historySearch" placeholder="Search polls..." 
               onkeyup="filterHistory()">
        <div id="historyList"></div>
      </div>
      
      <!-- Attendance History Tab -->
      <div class="sidebar-content tab-content" id="attendanceTab">
        <input type="text" class="form-control form-control-sm history-search" 
               id="attendanceSearch" placeholder="Search attendance..." 
               onkeyup="filterAttendanceHistory()">
        <div id="attendanceHistoryList"></div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <button class="btn btn-primary toggle-sidebar-btn" onclick="toggleSidebar()" id="toggleBtn">
        ‚ò∞
      </button>

      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4" style="margin-top: 50px;">
          <h1 class="mb-0">Polling Dashboard</h1>
          <div>
            <span id="welcomeUser" class="me-3"></span>
            <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
          </div>
        </div>

    <!-- Student Search Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">üîç Student Search</h5>
        <div class="row">
          <div class="col-md-8">
            <input type="text" id="studentSearch" class="form-control" placeholder="Search by Roll No, Name, or Email..." onkeyup="searchStudents()">
          </div>
          <div class="col-md-4">
            <button class="btn btn-secondary w-100" onclick="loadAllStudents()">üìã View All Students</button>
          </div>
        </div>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Create Poll</h5>
            <div class="mb-3">
              <label for="question" class="form-label">Question:</label>
              <input type="text" id="question" class="form-control">
            </div>
            <label class="form-label">Options:</label>
            <div class="input-group mb-2">
              <span class="input-group-text">A</span>
              <input type="text" id="optA" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">B</span>
              <input type="text" id="optB" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">C</span>
              <input type="text" id="optC" class="form-control">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">D</span>
              <input type="text" id="optD" class="form-control">
            </div>
            <div class="row">
              <div class="col">
                <label for="correct" class="form-label">Correct Option:</label>
                <select id="correct" class="form-select">
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                </select>
              </div>
              <div class="col">
                <label for="duration" class="form-label">Duration (s):</label>
                <input type="number" id="duration" value="30" min="10" class="form-control">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-danger" onclick="logoutAll()">Logout All Devices</button>
                <div>
                  <button class="btn btn-warning me-2" id="endPollBtn" onclick="endPoll()" style="display: none;">‚èπÔ∏è End Poll</button>
                  <button class="btn btn-primary" id="startPollBtn" onclick="startPoll()">üöÄ Start Poll</button>
                </div>
            </div>
            <div id="pollStatus" class="mt-3"></div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Live Results</h5>
            <div id="timer" class="fs-4 text-center my-3"></div>
            <div id="results">Waiting for votes...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Student Responses</h5>
            <div id="studentTable"></div>
            <button class="btn btn-secondary mt-3" onclick="downloadCSV()">üì• Export as CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Section -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üéì Attendance Session</h5>
            
            <!-- Start Attendance Form -->
            <div class="mb-3">
              <label for="attendanceDuration" class="form-label">Duration (minutes)</label>
              <input type="number" class="form-control" id="attendanceDuration" 
                     min="1" max="60" value="5" placeholder="Enter duration (1-60 min)">
            </div>
            
            <div class="mb-3">
              <label for="attendanceSection" class="form-label">Section (optional)</label>
              <select class="form-control" id="attendanceSection">
                <option value="ALL">All Sections</option>
                <option value="A">Section A</option>
                <option value="B">Section B</option>
              </select>
            </div>
            
            <button class="btn btn-success" id="startAttendanceBtn" onclick="startAttendance()">
              üü¢ Start Attendance
            </button>
            <button class="btn btn-danger" id="endAttendanceBtn" onclick="endAttendance()" style="display: none;">
              üî¥ End Attendance
            </button>
            
            <div id="attendanceStatus" class="mt-3"></div>
            
            <!-- Display Generated Code -->
            <div id="attendanceCodeDisplay" style="display: none;" class="mt-3">
              <div class="alert alert-success">
                <h4 class="alert-heading">Attendance Code:</h4>
                <h2 class="text-center mb-2" id="attendanceCode" style="font-family: monospace; letter-spacing: 4px;"></h2>
                <div class="text-center">
                  <button class="btn btn-sm btn-outline-success" onclick="copyAttendanceCode()">
                    üìã Copy Code
                  </button>
                </div>
                <div class="text-center mt-3">
                  <span class="fs-5">‚è±Ô∏è Time Remaining: <strong id="attendanceTimer">--:--</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Live Attendance</h5>
            <div id="attendanceStats" class="mb-3">
              <p>No active session</p>
            </div>
            <div id="attendanceList" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn btn-secondary mt-3" onclick="exportAttendance()" id="exportAttendanceBtn" style="display: none;">
              üì• Export as CSV
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check if user is logged in
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
      alert('Please login first');
      window.location.href = '/';
    } else {
      const welcomeEl = document.getElementById('welcomeUser');
      if (welcomeEl) {
        welcomeEl.textContent = `Welcome, ${loggedInUser.name || loggedInUser.username}!`;
      }
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('loggedInUser');
        window.location.href = '/';
      }
    }

    // Use relative URLs when hosted on same domain, or set full URL for separate hosting
    const server = window.location.origin;
    let currentPollId = null; // Track the current active poll

    function logoutAll() {
      fetch(server + "/logout_all", { method: "POST" })
        .then(res => res.json())
        .then(() => alert("‚úÖ All devices will be logged out"));
    }

    function startPoll() {
      const question = document.getElementById("question").value;
      const options = {
        A: document.getElementById("optA").value,
        B: document.getElementById("optB").value,
        C: document.getElementById("optC").value,
        D: document.getElementById("optD").value
      };
      const correct = document.getElementById("correct").value;
      const duration = document.getElementById("duration").value;

      if (!question || !options.A || !options.B || !options.C || !options.D) {
        document.getElementById("pollStatus").innerHTML = "<div class='alert alert-warning'>‚ö†Ô∏è Please fill all fields</div>";
        return;
      }

      fetch(`${server}/start_poll`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, options, correct, duration })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          currentPollId = data.pollId; // Store the poll ID
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-success'>‚úÖ Poll started!</div>";
          document.getElementById("startPollBtn").disabled = true;
          document.getElementById("endPollBtn").style.display = "inline-block";
        } else {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-danger'>‚ùå " + (data.message || "Failed to start poll") + "</div>";
        }
      });
    }

    function endPoll() {
      if (!confirm("Are you sure you want to end this poll now? Students won't be able to vote anymore.")) {
        return;
      }

      fetch(`${server}/end_poll`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          currentPollId = null; // Clear the poll ID
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-info'>üî¥ Poll ended manually</div>";
          document.getElementById("startPollBtn").disabled = false;
          document.getElementById("endPollBtn").style.display = "none";
        } else {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-danger'>‚ùå " + (data.message || "Failed to end poll") + "</div>";
        }
      });
    }

    // Student Search Functions
    let searchTimeout;
    function searchStudents() {
      clearTimeout(searchTimeout);
      const query = document.getElementById("studentSearch").value.trim();
      
      if (query.length < 2) {
        document.getElementById("searchResults").innerHTML = "";
        return;
      }

      searchTimeout = setTimeout(() => {
        fetch(`${server}/search_students?query=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            displaySearchResults(data);
          })
          .catch(error => {
            console.error("Search error:", error);
            document.getElementById("searchResults").innerHTML = "<div class='alert alert-danger'>Error searching students</div>";
          });
      }, 300); // Debounce 300ms
    }

    function loadAllStudents() {
      document.getElementById("searchResults").innerHTML = "<div class='text-center'><div class='spinner-border' role='status'></div><p>Loading all students...</p></div>";
      
      fetch(`${server}/all_students?limit=100`)
        .then(res => res.json())
        .then(data => {
          displaySearchResults(data);
        })
        .catch(error => {
          console.error("Load error:", error);
          document.getElementById("searchResults").innerHTML = "<div class='alert alert-danger'>Error loading students</div>";
        });
    }

    function displaySearchResults(data) {
      const resultsDiv = document.getElementById("searchResults");
      
      if (!data.success || data.students.length === 0) {
        resultsDiv.innerHTML = "<div class='alert alert-warning'>No students found</div>";
        return;
      }

      let html = `<div class="alert alert-info">Found ${data.count || data.students.length} student(s)`;
      if (data.total) {
        html += ` (Page ${data.page}/${data.pages}, Total: ${data.total})`;
      }
      html += `</div>`;
      
      html += `<div class="table-responsive"><table class="table table-striped table-hover table-sm">
        <thead>
          <tr>
            <th>SN</th>
            <th>Roll No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Section</th>
            <th>Group</th>
            <th>Branch</th>
            <th>Device Code</th>
          </tr>
        </thead>
        <tbody>`;
      
      data.students.forEach(student => {
        html += `<tr>
          <td>${student.sn}</td>
          <td><strong>${student.rollNo}</strong></td>
          <td>${student.name}</td>
          <td><small>${student.email}</small></td>
          <td>${student.section}</td>
          <td>${student.subGroup}</td>
          <td><span class="badge bg-primary">${student.branch}</span></td>
          <td><code>${student.deviceCode || 'N/A'}</code></td>
        </tr>`;
      });
      
      html += `</tbody></table></div>`;
      
      resultsDiv.innerHTML = html;
    }

    let lastPollResults = null;
    let currentActivePollId = null;

    function fetchResults() {
      // Fetch results - the endpoint now only returns active poll results
      fetch(`${server}/results`)
        .then(res => res.json())
        .then(data => {
          // Check if a new poll has started
          if (data.active && data.pollId !== currentActivePollId) {
            // New poll started - clear old results
            currentActivePollId = data.pollId;
            lastPollResults = null;
          }

          if (data.active) {
            // Active poll - store and display results
            currentPollId = data.pollId;
            lastPollResults = data;
            displayPollResults(data);
          } else if (!data.active && lastPollResults) {
            // Poll ended - keep showing last results
            displayPollResults(lastPollResults);
          } else {
            // No poll has been run yet
            document.getElementById("results").innerHTML = "<div class='alert alert-info'>No active poll. Start a new poll to see results.</div>";
            document.getElementById("studentTable").innerHTML = "";
          }
        });
    }

    function displayPollResults(data) {
      const summary = data.summary;
      const details = data.details;

      let summaryHTML = "<ul class='list-group'>";
      for (let option in summary) {
        summaryHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>${option}: <strong>${summary[option]} votes</strong></li>`;
      }
      summaryHTML += "</ul>"
      document.getElementById("results").innerHTML = summaryHTML || "No votes yet.";

      // Student response table
      let table = `<table class="table table-striped table-hover">
        <thead><tr><th>Roll No</th><th>Name</th><th>Vote</th><th>Correct?</th></tr></thead><tbody>`;
      for (let s of details) {
        const icon = s.correct ? "‚úÖ" : "‚ùå";
        table += `<tr><td>${s.rollNo}</td><td>${s.name}</td><td>${s.vote}</td><td>${icon}</td></tr>`;
      }
      table += "</tbody></table>";
      document.getElementById("studentTable").innerHTML = table;
    }

    function downloadCSV() {
      window.open(`${server}/export`, "_blank");
    }

    setInterval(fetchResults, 3000); // update every 3 sec
    setInterval(() => {
      fetch(`${server}/poll`)
        .then(res => res.json())
        .then(data => {
          if (data.active) {
            document.title = `${data.timeLeft}s left - ${data.question}`;
            document.getElementById("timer").innerHTML = `Time Left: <span class="badge bg-success">${data.timeLeft}s</span>`;
            document.getElementById("endPollBtn").style.display = "inline-block";
            document.getElementById("startPollBtn").disabled = true;
          } else {
            document.title = "Poll Ended";
            document.getElementById("timer").innerHTML = '';
            document.getElementById("endPollBtn").style.display = "none";
            document.getElementById("startPollBtn").disabled = false;
          }
        });
    }, 1000);

    // ========== ATTENDANCE FUNCTIONS ==========
    
    let attendanceInterval = null;
    let attendanceTimerInterval = null;

    function startAttendance() {
      const duration = document.getElementById("attendanceDuration").value;
      const section = document.getElementById("attendanceSection").value;

      if (!duration || duration < 1 || duration > 60) {
        document.getElementById("attendanceStatus").innerHTML = 
          "<div class='alert alert-warning'>Please enter a valid duration (1-60 minutes)</div>";
        return;
      }

      fetch(`${server}/start_attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ duration: parseInt(duration), section })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("attendanceStatus").innerHTML = 
            "<div class='alert alert-success'>Attendance session started!</div>";
          
          // Display the code
          document.getElementById("attendanceCode").textContent = data.code;
          document.getElementById("attendanceCodeDisplay").style.display = "block";
          
          // Toggle buttons
          document.getElementById("startAttendanceBtn").style.display = "none";
          document.getElementById("endAttendanceBtn").style.display = "inline-block";
          document.getElementById("exportAttendanceBtn").style.display = "inline-block";
          
          // Start fetching attendance updates
          startAttendancePolling();
        } else {
          document.getElementById("attendanceStatus").innerHTML = 
            "<div class='alert alert-danger'>" + (data.message || "Failed to start attendance") + "</div>";
        }
      })
      .catch(error => {
        console.error("Error starting attendance:", error);
        document.getElementById("attendanceStatus").innerHTML = 
          "<div class='alert alert-danger'>Error starting attendance</div>";
      });
    }

    function endAttendance() {
      if (!confirm("Are you sure you want to end this attendance session? Students won't be able to mark attendance anymore.")) {
        return;
      }

      fetch(`${server}/end_attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("attendanceStatus").innerHTML = 
            "<div class='alert alert-info'>Attendance session ended</div>";
          
          // Hide code display
          document.getElementById("attendanceCodeDisplay").style.display = "none";
          
          // Toggle buttons
          document.getElementById("startAttendanceBtn").style.display = "inline-block";
          document.getElementById("endAttendanceBtn").style.display = "none";
          
          // Stop polling
          stopAttendancePolling();
        } else {
          document.getElementById("attendanceStatus").innerHTML = 
            "<div class='alert alert-danger'>" + (data.message || "Failed to end attendance") + "</div>";
        }
      })
      .catch(error => {
        console.error("Error ending attendance:", error);
        document.getElementById("attendanceStatus").innerHTML = 
          "<div class='alert alert-danger'>Error ending attendance</div>";
      });
    }

    function copyAttendanceCode() {
      const code = document.getElementById("attendanceCode").textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert("Code copied to clipboard: " + code);
      }).catch(err => {
        console.error("Failed to copy:", err);
        alert("Failed to copy code");
      });
    }

    function fetchAttendanceStatus() {
      fetch(`${server}/get_attendance`)
        .then(res => res.json())
        .then(data => {
          if (data.active) {
            // Update timer
            const minutes = Math.floor(data.timeLeft / 60);
            const seconds = data.timeLeft % 60;
            document.getElementById("attendanceTimer").textContent = 
              `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Fetch and display attendance list
            fetchAttendanceList();
          } else {
            // No active session - reset UI
            document.getElementById("attendanceCodeDisplay").style.display = "none";
            document.getElementById("startAttendanceBtn").style.display = "inline-block";
            document.getElementById("endAttendanceBtn").style.display = "none";
            document.getElementById("attendanceStats").innerHTML = "<p>No active session</p>";
            document.getElementById("attendanceList").innerHTML = "";
            stopAttendancePolling();
          }
        })
        .catch(error => {
          console.error("Error fetching attendance status:", error);
        });
    }

    function fetchAttendanceList() {
      fetch(`${server}/attendance_results`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Update stats
            const stats = data.summary;
            document.getElementById("attendanceStats").innerHTML = `
              <div class="alert alert-info">
                <strong>Total Present:</strong> ${stats.present} / ${stats.totalStudents} 
                (${stats.presentPercentage}%)
                <br><strong>Absent:</strong> ${stats.absent}
              </div>
            `;
            
            // Update attendance list
            if (data.records.length === 0) {
              document.getElementById("attendanceList").innerHTML = 
                "<div class='alert alert-warning'>No students have marked attendance yet.</div>";
            } else {
              let table = `<table class="table table-striped table-hover table-sm">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>`;
              
              data.records.forEach((record, index) => {
                const time = new Date(record.markedAt).toLocaleTimeString();
                table += `<tr>
                  <td>${index + 1}</td>
                  <td><strong>${record.rollNo}</strong></td>
                  <td>${record.name}</td>
                  <td><small>${time}</small></td>
                </tr>`;
              });
              
              table += "</tbody></table>";
              document.getElementById("attendanceList").innerHTML = table;
            }
          }
        })
        .catch(error => {
          console.error("Error fetching attendance list:", error);
        });
    }

    function startAttendancePolling() {
      // Clear any existing intervals
      stopAttendancePolling();
      
      // Fetch immediately
      fetchAttendanceStatus();
      
      // Then poll every second for timer updates
      attendanceTimerInterval = setInterval(fetchAttendanceStatus, 1000);
      
      // Poll every 3 seconds for attendance list updates
      attendanceInterval = setInterval(fetchAttendanceList, 3000);
    }

    function stopAttendancePolling() {
      if (attendanceInterval) {
        clearInterval(attendanceInterval);
        attendanceInterval = null;
      }
      if (attendanceTimerInterval) {
        clearInterval(attendanceTimerInterval);
        attendanceTimerInterval = null;
      }
    }

    function exportAttendance() {
      window.open(`${server}/export_attendance`, "_blank");
    }

    // Check for active attendance session on page load
    fetchAttendanceStatus();

    // ========== HISTORY SIDEBAR FUNCTIONS ==========
    
    let pollHistory = [];
    let selectedPollId = null;

    function toggleSidebar() {
      const sidebar = document.getElementById('historySidebar');
      const toggleBtn = document.getElementById('toggleBtn');
      sidebar.classList.toggle('collapsed');
      
      if (sidebar.classList.contains('collapsed')) {
        toggleBtn.innerHTML = '‚ò∞';
      } else {
        toggleBtn.innerHTML = '‚ò∞';
      }
    }

    function loadPollHistory() {
      fetch(`${server}/poll_history?limit=50`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            pollHistory = data.polls;
            renderHistory();
            document.getElementById('historyCount').textContent = 
              `${data.count} poll${data.count !== 1 ? 's' : ''}`;
          }
        })
        .catch(error => {
          console.error('Error loading poll history:', error);
          document.getElementById('historyCount').textContent = 'Error loading';
        });
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      
      if (pollHistory.length === 0) {
        historyList.innerHTML = '<p class="text-muted text-center">No polls yet</p>';
        return;
      }

      historyList.innerHTML = pollHistory.map(poll => {
        const date = new Date(poll.createdAt);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const badge = poll.active ? 
          '<span class="poll-badge active">Active</span>' : 
          '<span class="poll-badge completed">Completed</span>';
        
        return `
          <div class="history-item" data-poll-id="${poll.pollId}" onclick="togglePollDetails('${poll.pollId}')">
            <div class="history-question">${poll.question}${badge}</div>
            <div class="history-meta">
              ${dateStr} | ${poll.totalVotes || 0} vote${poll.totalVotes !== 1 ? 's' : ''}
            </div>
            <div class="history-details" id="details-${poll.pollId}">
              <div><strong>Options:</strong></div>
              <ul style="font-size: 12px; margin: 5px 0;">
                <li>A: ${poll.options.A}</li>
                <li>B: ${poll.options.B}</li>
                <li>C: ${poll.options.C}</li>
                <li>D: ${poll.options.D}</li>
              </ul>
              <div><strong>Correct:</strong> ${poll.correct}</div>
              <div><strong>Results:</strong></div>
              <ul style="font-size: 12px; margin: 5px 0;">
                <li>A: ${poll.voteCounts.A || 0} votes</li>
                <li>B: ${poll.voteCounts.B || 0} votes</li>
                <li>C: ${poll.voteCounts.C || 0} votes</li>
                <li>D: ${poll.voteCounts.D || 0} votes</li>
              </ul>
              <div class="history-actions">
                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); exportPollCSV('${poll.pollId}')">
                  Export
                </button>
                ${!poll.active ? `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deletePoll('${poll.pollId}')">
                  Delete
                </button>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function togglePollDetails(pollId) {
      const details = document.getElementById(`details-${pollId}`);
      const allDetails = document.querySelectorAll('.history-details');
      
      // Close all other details
      allDetails.forEach(d => {
        if (d.id !== `details-${pollId}`) {
          d.classList.remove('expanded');
        }
      });
      
      // Toggle current
      details.classList.toggle('expanded');
      selectedPollId = details.classList.contains('expanded') ? pollId : null;
    }

    function filterHistory() {
      const searchTerm = document.getElementById('historySearch').value.toLowerCase();
      const items = document.querySelectorAll('.history-item');
      
      items.forEach(item => {
        const question = item.querySelector('.history-question').textContent.toLowerCase();
        if (question.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function exportPollCSV(pollId) {
      window.open(`${server}/export_poll/${pollId}`, '_blank');
    }

    function deletePoll(pollId) {
      if (!confirm('Are you sure you want to delete this poll? This action cannot be undone.')) {
        return;
      }

      fetch(`${server}/poll/${pollId}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Poll deleted successfully');
          loadPollHistory(); // Reload history
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error deleting poll:', error);
        alert('Error deleting poll');
      });
    }

    // ========== TAB SWITCHING ==========
    
    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.sidebar-tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      const pollsTab = document.getElementById('pollsTab');
      const attendanceTab = document.getElementById('attendanceTab');
      
      if (tabName === 'polls') {
        pollsTab.classList.add('active');
        attendanceTab.classList.remove('active');
        document.getElementById('historyCount').textContent = 
          `${pollHistory.length} poll${pollHistory.length !== 1 ? 's' : ''}`;
      } else if (tabName === 'attendance') {
        pollsTab.classList.remove('active');
        attendanceTab.classList.add('active');
        document.getElementById('historyCount').textContent = 
          `${attendanceHistory.length} session${attendanceHistory.length !== 1 ? 's' : ''}`;
      }
    }

    // ========== ATTENDANCE HISTORY FUNCTIONS ==========
    
    let attendanceHistory = [];
    let selectedAttendanceId = null;

    function loadAttendanceHistory() {
      fetch(`${server}/attendance_history?limit=50`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            attendanceHistory = data.sessions;
            renderAttendanceHistory();
          }
        })
        .catch(error => {
          console.error('Error loading attendance history:', error);
        });
    }

    function renderAttendanceHistory() {
      const historyList = document.getElementById('attendanceHistoryList');
      
      if (attendanceHistory.length === 0) {
        historyList.innerHTML = '<p class="text-muted text-center">No attendance sessions yet</p>';
        return;
      }

      historyList.innerHTML = attendanceHistory.map(session => {
        const date = new Date(session.startTime);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const badge = session.active ? 
          '<span class="poll-badge active">Active</span>' : 
          '<span class="poll-badge completed">Completed</span>';
        
        const sectionText = session.section ? `Section: ${session.section}` : 'All Sections';
        
        return `
          <div class="history-item" data-session-id="${session.sessionId}" onclick="toggleAttendanceDetails('${session.sessionId}')">
            <div class="history-question">${sectionText} - ${session.duration} min${badge}</div>
            <div class="history-meta">
              ${dateStr} | ${session.totalPresent} present (${session.presentPercentage}%)
            </div>
            <div class="history-details" id="attd-details-${session.sessionId}">
              <div><strong>Code:</strong> ${session.code}</div>
              <div><strong>Duration:</strong> ${session.duration} minutes</div>
              <div><strong>Section:</strong> ${session.section || 'All'}</div>
              <div class="mt-2"><strong>Statistics:</strong></div>
              <ul style="font-size: 12px; margin: 5px 0;">
                <li>Present: ${session.totalPresent}</li>
                <li>Absent: ${session.totalAbsent}</li>
                <li>Percentage: ${session.presentPercentage}%</li>
              </ul>
              <div class="mt-2"><strong>Attendees (${session.records.length}):</strong></div>
              <div style="max-height: 150px; overflow-y: auto; font-size: 11px; margin: 5px 0;">
                ${session.records.map(r => {
                  const time = new Date(r.markedAt).toLocaleTimeString();
                  return `<div style="padding: 2px 0; border-bottom: 1px solid #eee;">
                    <strong>${r.rollNo}</strong> - ${r.name} <small>(${time})</small>
                  </div>`;
                }).join('')}
              </div>
              <div class="history-actions">
                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); exportAttendanceCSV('${session.sessionId}')">
                  Export
                </button>
                ${!session.active ? `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteAttendance('${session.sessionId}')">
                  Delete
                </button>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleAttendanceDetails(sessionId) {
      const details = document.getElementById(`attd-details-${sessionId}`);
      const allDetails = document.querySelectorAll('.history-details');
      
      // Close all other details
      allDetails.forEach(d => {
        if (d.id !== `attd-details-${sessionId}`) {
          d.classList.remove('expanded');
        }
      });
      
      // Toggle current
      details.classList.toggle('expanded');
      selectedAttendanceId = details.classList.contains('expanded') ? sessionId : null;
    }

    function filterAttendanceHistory() {
      const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
      const items = document.querySelectorAll('#attendanceHistoryList .history-item');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function exportAttendanceCSV(sessionId) {
      window.open(`${server}/export_attendance/${sessionId}`, '_blank');
    }

    function deleteAttendance(sessionId) {
      if (!confirm('Are you sure you want to delete this attendance session? This action cannot be undone.')) {
        return;
      }

      fetch(`${server}/attendance/${sessionId}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Attendance session deleted successfully');
          loadAttendanceHistory(); // Reload history
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error deleting attendance:', error);
        alert('Error deleting attendance session');
      });
    }

    // Load both histories on page load
    loadPollHistory();
    loadAttendanceHistory();
    
    // Refresh history every 10 seconds
    setInterval(loadPollHistory, 10000);
    setInterval(loadAttendanceHistory, 10000);
  </script>
      </div> <!-- end container-fluid -->
    </div> <!-- end main-content -->
  </div> <!-- end dashboard-container -->
</body>
</html>
