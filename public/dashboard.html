<!DOCTYPE html>
<html>
<head>
  <title>Instructor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">üìä Polling Dashboard</h1>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Create Poll</h5>
            <div class="mb-3">
              <label for="question" class="form-label">Question:</label>
              <input type="text" id="question" class="form-control">
            </div>
            <label class="form-label">Options:</label>
            <div class="input-group mb-2">
              <span class="input-group-text">A</span>
              <input type="text" id="optA" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">B</span>
              <input type="text" id="optB" class="form-control">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">C</span>
              <input type="text" id="optC" class="form-control">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">D</span>
              <input type="text" id="optD" class="form-control">
            </div>
            <div class="row">
              <div class="col">
                <label for="correct" class="form-label">Correct Option:</label>
                <select id="correct" class="form-select">
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                </select>
              </div>
              <div class="col">
                <label for="duration" class="form-label">Duration (s):</label>
                <input type="number" id="duration" value="30" min="10" class="form-control">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-danger" onclick="logoutAll()">Logout All Devices</button>
                <button class="btn btn-primary" onclick="startPoll()">üöÄ Start Poll</button>
            </div>
            <div id="pollStatus" class="mt-3"></div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Live Results</h5>
            <div id="timer" class="fs-4 text-center my-3"></div>
            <div id="results">Waiting for votes...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Student Responses</h5>
            <div id="studentTable"></div>
            <button class="btn btn-secondary mt-3" onclick="downloadCSV()">üì• Export as CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const server = "http://localhost:3000";

    function logoutAll() {
      fetch(server + "/logout_all", { method: "POST" })
        .then(res => res.json())
        .then(() => alert("‚úÖ All devices will be logged out"));
    }

    function startPoll() {
      const question = document.getElementById("question").value;
      const options = {
        A: document.getElementById("optA").value,
        B: document.getElementById("optB").value,
        C: document.getElementById("optC").value,
        D: document.getElementById("optD").value
      };
      const correct = document.getElementById("correct").value;
      const duration = document.getElementById("duration").value;

      fetch(`${server}/start_poll`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, options, correct, duration })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-success'>‚úÖ Poll started!</div>";
        } else {
          document.getElementById("pollStatus").innerHTML = "<div class='alert alert-danger'>‚ùå Failed to start poll</div>";
        }
      });
    }

    function fetchResults() {
      fetch(`${server}/results`)
        .then(res => res.json())
        .then(data => {
          const summary = data.summary;
          const details = data.details;

          let summaryHTML = "<ul class='list-group'>";
          for (let option in summary) {
            summaryHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>${option}: <strong>${summary[option]} votes</strong></li>`;
          }
          summaryHTML += "</ul>"
          document.getElementById("results").innerHTML = summaryHTML || "No votes yet.";

          // Student response table
          let table = `<table class="table table-striped table-hover">
            <thead><tr><th>Roll No</th><th>Name</th><th>Vote</th><th>Correct?</th></tr></thead><tbody>`;
          for (let s of details) {
            const icon = s.correct ? "‚úÖ" : "‚ùå";
            table += `<tr><td>${s.rollNo}</td><td>${s.name}</td><td>${s.vote}</td><td>${icon}</td></tr>`;
          }
          table += "</tbody></table>";
          document.getElementById("studentTable").innerHTML = table;
        });
    }

    function downloadCSV() {
      window.open(`${server}/export`, "_blank");
    }

    setInterval(fetchResults, 3000); // update every 3 sec
    setInterval(() => {
      fetch(`${server}/poll`)
        .then(res => res.json())
        .then(data => {
          if (data.active) {
            document.title = `‚è≥ ${data.timeLeft}s left - ${data.question}`;
            document.getElementById("timer").innerHTML = `Time Left: <span class="badge bg-success">${data.timeLeft}s</span>`;
          } else {
            document.title = "‚úÖ Poll Ended";
            document.getElementById("timer").innerHTML = '';
          }
        });
    }, 1000);
  </script>
</body>
</html>
